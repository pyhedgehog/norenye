user  nginx;
worker_processes  3;

error_log  /var/log/nginx/error.log error; # notice;
pid        /var/run/nginx.pid;

load_module modules/ngx_http_js_module.so;
events {
    worker_connections  1024;
}
http {
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile        on;
    #tcp_nopush     on;
    keepalive_timeout  65;
    #gzip  on;

    js_path /etc/nginx/js/;
    js_import norenye.js;
    js_shared_dict_zone zone=norenye:1M;
    server {
        listen 8080;
        server_name *.example.com;
        root /usr/share/nginx/html;
        js_set $norenye_fail norenye.getfail;
        js_set $norenye_target norenye.gettarget;
        set $norenye_config '/etc/nginx/norenye.json';
        set $norenye_shared_dict norenye;
        location /_/static/ {
        }
        location = /favicon.ico {
          root /usr/share/nginx/html/_/static/;
        }
        location = /_/health {
          types { }
          default_type application/json;
          return 200 '{"status": "ok"}';
        }
        location /_/ {
            # js_content norenye.api;
            js_content norenye.public_api;
            # js_content norenye.indexjson;
            # js_content norenye.sessionjson;
            # js_content norenye.configjson;
            # js_content norenye.dbgpage;
            # If you want to expose api via another interface/vhost replace with:
            #   js_content norenye.public_api;  # limit api to /_/, /_/index.html and /_/index.json
            #   js_content norenye.public_html;  # limit api to /_/, /_/index.html
            #   js_content norenye.admin_api;  # all api except /_/, /_/index.html and /_/index.json, '/_/' will return list of API endpoints.
        }
        location /_admin_/static/ {
          alias /usr/share/nginx/html/_/static/;
        }
        location /_admin_/ {
          set $norenye_uri /_admin_/;
          js_content norenye.admin_api;
        }
        location / {
            proxy_set_header Host $host;
            if ($norenye_target) {
              proxy_pass $norenye_target;
            }
            if ($norenye_fail) {
              return 302 '/_/';
            }
        }
        #error_page  404              /404.html;
        error_page  500 502 503 504  /50x.html;
        location = /50x.html {
            root /usr/share/nginx/html;
        }
    }
    server {
        listen 8001;
        server_name svc1.example.com;
        location / {
          return 200 svc1=$uri;
        }
    }
    server {
        listen 8002;
        server_name svc2.example.com;
        location / {
          return 200 svc2=$uri;
        }
    }
    server {
        listen 8003;
        server_name svc3.example.com;
        location / {
          return 200 svc3=$uri;
        }
    }
}
